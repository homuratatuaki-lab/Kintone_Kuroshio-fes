# 祭典団体状況 一括同期プラグイン（Advanced）

団体管理アプリ（親）から子アプリ（申込書など）の状況を集計し、団体管理アプリおよび連絡先アプリの関連レコードを一括更新・強制同期する Kintone プラグインです。

## 機能

- **キー**: 団体IDで紐付け（アプリごとにフィールドコードは設定でマッピング）
- **実行範囲**: 団体管理アプリの**全レコード**
- **子アプリ集計（子 → 親）**
  - 団体IDが一致するレコードを「作成日時が新しい順」で取得
  - **存在確認モード**: 1件以上あれば「提出済」、0件なら「未提出」を親の反映先に書き込み
  - **値のコピーモード**: 最新1件の指定フィールド値をコピー。0件の場合は空で上書き
- **波及更新（親 → 連絡先）**
  - 親更新後、連絡先アプリ内で団体IDが一致する**全レコード**に、同じ値を強制上書き（PUT）

## 設定項目（設定画面）

設定画面では**アプリ・フィールドをすべて選択式**で指定します（ラベルやアプリ名から選べます）。

- **子アプリ設定**（テーブル・行追加可）
  - 参照先アプリ（ドロップダウン：アプリ名で選択）
  - 子アプリ側 団体IDフィールド（選択したアプリのフィールド一覧から選択）
  - 判定モード（存在確認 / 値のコピー）
  - コピー元フィールド（値のコピー時のみ、同アプリのフィールドから選択）
  - 親アプリ 反映先フィールド（自アプリのフィールドから選択）
- **親アプリ（自アプリ）設定**
  - 自アプリ側 団体IDフィールド（自アプリのフィールドから選択）
- **連絡先アプリ設定**
  - 連絡先アプリ（ドロップダウンで選択）
  - 連絡先アプリ側 団体IDフィールド・反映先フィールド（選択したアプリのフィールドから選択）

※ 各行で「親アプリ 反映先フィールド」を指定するため、子アプリごとに別々のフィールドへ反映できます。連絡先には先頭行の結果を1フィールドに同期します。

## ファイル構成

```
Kintone_黒潮祭アプリ/
├── manifest.json       # プラグイン定義
├── package.json        # npm スクリプト（パッケージ化用）
├── scripts/
│   └── ensure-icon.js  # image/icon.png が無い場合にプレースホルダーを生成
├── html/
│   └── config.html     # 設定画面
├── css/
│   ├── config.css
│   └── desktop.css
├── js/
│   ├── config.js       # 設定の保存・読み込み
│   ├── sync.js         # 同期ロジック（子→親→連絡先）
│   └── desktop.js      # 一覧画面に「一括同期」ボタン追加
├── image/
│   └── icon.png        # プラグインアイコン（64×64 推奨・無ければ npm run pack で自動作成）
└── README.md
```

## Git（バージョン管理）

- リポジトリのクローン後、そのまま開発・パッケージ化が可能です。
- **コミットしないもの**: `.gitignore` で除外しています。
  - `plugin.zip` … パッケージ化で生成されるため
  - `*.ppk` … 秘密鍵は手元で厳重に保管し、リポジトリには含めない
  - `node_modules/` … npm の依存（本プラグインは `npx` 利用のため通常は空）
  - `.cursor/`, `.DS_Store` など

```bash
# クローン
git clone https://github.com/homuratatuaki-lab/Kintone_Kuroshio-fes.git
cd Kintone_Kuroshio-fes

# 変更をコミット
git add .
git commit -m "メッセージ"
git push origin main
```

## パッケージ化（plugin.zip の作成）

### 1. アイコン

`image/icon.png` が無い場合は `npm run pack` 実行時に `scripts/ensure-icon.js` で 64×64 のプレースホルダーが自動作成されます。任意の 64×64 PNG に差し替えて構いません。

### 2. パッケージ化コマンド

**事前条件**: Node.js がインストールされていること。

**初回**（秘密鍵を新規生成）:

```bash
npm run pack
```

- 実行後、**秘密鍵ファイル**（`<プラグインID>.ppk`）がルートに生成されます。必ず手元で保管してください。

**2回目以降**（既存プラグインを上書きする場合）:

同じプラグインとして認識させるには、**初回に生成した .ppk ファイル**を指定します。

```bash
npm run pack:update
```

- ルートに 1 つだけ `.ppk` がある場合に使用できます。複数ある場合は手動で指定してください:

```bash
npx @kintone/plugin-packer . --ppk <プラグインID>.ppk --out plugin.zip
```

**保存先の例**:

- 同じフォルダに出力: `--out plugin.zip` または `--out ./plugin.zip`
- 別フォルダに出力: `--out ../dist/plugin.zip`

**秘密鍵（.ppk）の扱い**:

- **厳重に保管**してください。同じ .ppk を使わないと「別プラグイン」として扱われ、Kintone 上で上書きできません。
- バージョン更新で同じプラグインを差し替えるときは、必ず同じ .ppk でパッケージ化してください。
- .ppk は**バージョン管理に含めず**、安全な場所に手元保管することを推奨します。

### 3. Kintone へ .zip をアップロードする手順

1. **ログイン**: Kintone に管理者（またはプラグインの追加権限があるユーザー）でログインします。
2. **設定メニューを開く**: 画面右上の **⚙（歯車）** をクリックし、**「設定」** を開きます。
3. **プラグイン一覧へ**: 左メニューで **「プラグイン」** をクリックします。
4. **プラグインの追加**: **「プラグインの追加」** または **「追加」** ボタンをクリックします。
5. **ZIP を選択**: **「ファイルを選択」** から、上記で作成した **`plugin.zip`** を選び、**「追加」**（または「アップロード」）をクリックします。
6. **有効化**: 追加されたプラグインの **「有効」** をオンにし、必要に応じて **「設定」** からアプリごとのプラグイン設定を行います。
7. **アプリで有効化**: 団体管理アプリの **「設定」** → **「プラグイン」** で、このプラグインにチェックを入れて保存します。その後、プラグインの **「設定」** から子アプリ・親・連絡先のマッピングを保存します。

**補足**:

- 2回目以降は、同じ .ppk でパッケージした `plugin.zip` を再度アップロードすると、**既存のプラグインが更新**されます（新規追加にはなりません）。
- 管理者メニューは環境により **「cybozu.com 管理」** → **「kintone」** → **「プラグイン」** の順になる場合もあります。

## 導入方法（利用者向け）

1. 上記「パッケージ化」で作成した **plugin.zip** を、Kintone の設定画面からプラグインとして追加・有効化します。
2. **団体管理アプリ**の設定でこのプラグインを有効にし、プラグインの設定画面でアプリ・フィールドを選択して保存します。
3. 団体管理アプリの一覧画面に「一括同期を実行」ボタンが表示されます。クリックで全レコードを対象に同期が実行されます。

## 注意事項

- プラグインを有効にするのは**団体管理アプリ（親）**のみです。
- 子アプリ・連絡先アプリは同一サブドメイン内で、API で参照・更新できる必要があります。
- 連絡先の更新は 100 件ずつ PUT で送信し、同一団体IDのレコードが 500 件を超える場合はループで全件取得してから更新します。

## 技術仕様（補足）

- 設定はプラグインの「アプリ設定」として保存（`kintone.plugin.app.config`）。
- 一覧表示時のみ同期ボタンを表示（`app.record.index.show`）。
- 子アプリの取得は `orderBy("作成日時", "desc") limit(1)` で最新1件を取得。
- 親アプリの全件取得は 500 件ずつオフセットで取得。
