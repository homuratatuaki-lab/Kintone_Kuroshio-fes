# 黒潮祭 連携プラグイン

団体管理アプリから申請書の提出状況を集計し、団体管理および連絡先アプリの関連レコードを一括更新する Kintone プラグインです。

## 機能

- **キー**: 団体IDなどで紐付け（アプリごとにフィールドコードは設定でマッピング）
- **実行範囲**: 団体管理アプリの**全レコード**
- **申請書集計（子 → 団体管理）**
  - 団体IDが一致するレコードを「作成日時が新しい順」で取得
  - **提出チェック**: 1件以上あれば「提出済」、0件なら「未提出」を団体管理の反映先に書き込み
  - **内容取得**: 最新1件の指定フィールド値をコピー。0件の場合は空で上書き
- **波及更新（団体管理 → 連絡先）**
  - 団体管理更新後、連絡先アプリ内で団体IDが一致する**全レコード**に、同じ値を強制上書き（PUT）
- **編集不可フィールド**
  - 団体管理アプリ: 「→ 団体管理に表示」で指定したフィールドは、追加・編集・一覧からの編集で編集不可（APIからのみ更新可能）
  - 連絡先アプリ: 設定の「編集不可にする欄」でチェックしたフィールドを同様に編集不可にできる

## 設定画面

設定では**このアプリの役割**でモードを切り替えます。

- **団体管理**（デフォルト）: 同期を実行するアプリ。以下の 3 ステップで設定します。
- **連絡先（同期先・表示用）**: 同期先アプリ。編集制限と一覧絞り込みの設定のみ行います。

### 団体管理モードの設定

1. **団体管理の紐付け**  
   団体1件に対応する項目（紐付けキー）を選びます。
2. **連絡先の設定**  
   結果を反映する連絡先アプリと、そのアプリの紐付けキーを選びます。
3. **申請書の指定**  
   提出状況を集計する申請書アプリをテーブルで追加します。
   - **申請書アプリ** / **紐付けキー** / **連携モード**（提出チェック or 内容取得）/ **取得する欄（内容取得時）** / **→ 団体管理に表示** / **→ 連絡先に表示**
   - 「→ 団体管理に表示」で指定したフィールドは、編集画面で編集不可（APIからのみ更新）になります。

### 連絡先モードの設定

1. **フラグ欄の編集制限（APIからのみ更新可）**  
   同期で更新される欄のうち、編集不可にする欄をチェックで選択します。
2. **一覧の絞り込み**  
   「一覧でフラグによる絞り込みをする」をオンにすると、一覧に「表示: 全て / 提出済あり / 未提出のみ」のドロップダウンが表示されます。

※ アプリ・フィールドはすべて選択式（ドロップダウン）で指定します。

## 編集不可になるフィールド

- **団体管理アプリ**: 設定の「申請書の指定」で **「→ 団体管理に表示」** に指定したフィールドが、レコード追加・編集・一覧からの編集のいずれでも編集不可（グレーアウト）になります。
- **連絡先アプリ**: 設定の **「編集不可にする欄」** でチェックしたフィールドが同様に編集不可になります。
- 閲覧画面（詳細表示）は対象外です。編集ボタンから開いた画面でロックがかかります。

## ファイル構成

```
Kintone_黒潮祭アプリ/
├── manifest.json       # プラグイン定義
├── package.json        # npm スクリプト（パッケージ化用）
├── scripts/
│   └── ensure-icon.js  # image/icon.png が無い場合にプレースホルダーを生成
├── html/
│   └── config.html     # 設定画面
├── css/
│   ├── config.css      # 設定画面のスタイル（手書き）
│   └── desktop.css     # 一覧・同期ボタン・連絡先絞り込みのスタイル
├── js/
│   ├── config.js       # 設定の保存・読み込み
│   ├── sync.js         # 同期ロジック（子→親→連絡先）
│   └── desktop.js      # 一括同期ボタン・連絡先絞り込み・編集不可制御
├── image/
│   └── icon.png        # プラグインアイコン（64×64 推奨・無ければ pack で自動作成）
└── README.md
```

## Git（バージョン管理）

- リポジトリのクローン後、そのまま開発・パッケージ化が可能です。
- **コミットしないもの**: `.gitignore` で除外しています。
  - `plugin.zip` … パッケージ化で生成されるため
  - `*.ppk` … 秘密鍵は手元で厳重に保管し、リポジトリには含めない
  - `node_modules/` … npm の依存
  - `.cursor/`, `.DS_Store` など

```bash
git clone https://github.com/homuratatuaki-lab/Kintone_Kuroshio-fes.git
cd Kintone_Kuroshio-fes

git add .
git commit -m "メッセージ"
git push origin main
```

## パッケージ化（plugin.zip の作成）

**事前条件**: Node.js がインストールされていること。

### アイコン

`image/icon.png` が無い場合は `npm run pack` / `npm run pack:update` 実行時に `scripts/ensure-icon.js` で 64×64 のプレースホルダーが自動作成されます。任意の 64×64 PNG に差し替えて構いません。

### コマンド

**初回**（秘密鍵を新規生成）:

```bash
npm run pack
```

- 実行後、**秘密鍵ファイル**（`<プラグインID>.ppk`）がルートに生成されます。必ず手元で保管してください。

**2回目以降**（既存プラグインを上書きする場合）:

```bash
npm run pack:update
```

- ルートに 1 つだけ `.ppk` がある場合に使用できます。複数ある場合は手動で指定してください:

```bash
npx kintone-plugin-packer . --ppk <プラグインID>.ppk --out plugin.zip
```

**秘密鍵（.ppk）の扱い**:

- **厳重に保管**してください。同じ .ppk を使わないと「別プラグイン」として扱われ、Kintone 上で上書きできません。
- .ppk は**バージョン管理に含めず**、安全な場所に手元保管することを推奨します。

### Kintone へ .zip をアップロードする手順

1. Kintone に管理者（またはプラグインの追加権限があるユーザー）でログインする。
2. 画面右上の **⚙（歯車）** → **「設定」** を開く。
3. 左メニューで **「プラグイン」** をクリックする。
4. **「プラグインの追加」** 等から、作成した **`plugin.zip`** を選択して追加する。
5. 追加されたプラグインを**有効**にし、必要に応じて各アプリの設定でプラグインを有効化し、プラグインの「設定」から紐付け等を保存する。

2回目以降は、同じ .ppk でパッケージした `plugin.zip` を再度アップロードすると、**既存のプラグインが更新**されます。

## 導入方法（利用者向け）

1. 上記「パッケージ化」で作成した **plugin.zip** を、Kintone の設定画面からプラグインとして追加・有効化する。
2. **団体管理アプリ**の設定でこのプラグインを有効にし、プラグインの設定画面で「このアプリの役割」を**団体管理**のまま、団体管理の紐付け・連絡先・申請書の指定を保存する。
3. 団体管理アプリの一覧画面に「一括同期を実行」ボタンが表示される。クリックで全レコードを対象に同期が実行される。
4. **連絡先アプリ**でもプラグインを有効にし、設定で「このアプリの役割」を**連絡先**にすると、編集不可にする欄や一覧の絞り込みを設定できる。
5. **一覧のデフォルト表示**: 団体管理の設定で「連絡先一覧のデフォルト表示」、連絡先の設定で「一覧を開いたときの表示」を選ぶと、連絡先アプリの一覧を開いた時点でその条件（全て／提出済あり／未提出のみ）が自動でかかります。団体管理で決めた方針に合わせて連絡先でも同じ値を選ぶと、同じ絞り込みが反映されます。
6. **提出物ごとの一覧View**: 連絡先のプラグイン設定で「提出物ごとの一覧View」に、表示名（例: 〇〇申請書）と提出状況が入る欄（フィールド）を追加すると、一覧画面の「表示」ドロップダウンに「〇〇申請書（提出済）」「〇〇申請書（未提出）」が追加され、提出物（申請書）ごとに絞り込んだ一覧に切り替えられます。

## 注意事項

- プラグインは**団体管理アプリ**と**連絡先アプリ**の両方で有効にできる。団体管理側で紐付け・申請書を設定し、連絡先側で「このアプリの役割」を連絡先にすると編集制限や一覧絞り込みが使える。
- 申請書アプリ・連絡先アプリは同一サブドメイン内で、API で参照・更新できる必要がある。
- 連絡先の更新は 100 件ずつ PUT で送信し、同一団体IDのレコードが 500 件を超える場合はループで全件取得してから更新する。

## 技術仕様（補足）

- 設定はプラグインの「アプリ設定」として保存（`kintone.plugin.app.config`）。
- 一覧表示時のみ団体管理アプリに同期ボタンを表示（`app.record.index.show`）。連絡先アプリでは表示しない。
- 編集不可は `app.record.create.show` / `app.record.edit.show` / `app.record.index.edit.show` で、設定に基づき該当フィールドに `disabled = true` を付与。
- 子アプリの取得は `orderBy("作成日時", "desc") limit(1)` で最新1件を取得。
- 親アプリの全件取得は 500 件ずつオフセットで取得。
